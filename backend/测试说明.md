# æ™ºèƒ½è¡¨å•åŠ©æ‰‹åç«¯ - æµ‹è¯•è¯´æ˜

## ğŸ§ª æµ‹è¯•æ¦‚è§ˆ

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„åç«¯æµ‹è¯•æŒ‡å—ï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•å’Œè”è°ƒæµ‹è¯•ã€‚

---

## ğŸ“‹ æµ‹è¯•å‰å‡†å¤‡

### 1. ç¡®ä¿æœåŠ¡å·²å¯åŠ¨
```bash
python main.py
```

### 2. å‡†å¤‡æµ‹è¯•æ•°æ®

åˆ›å»ºæµ‹è¯•ç›®å½•ï¼š
```bash
mkdir -p tests/test_data
```

å‡†å¤‡æµ‹è¯•æ–‡ä»¶ï¼š
- `test_image.jpg` - æµ‹è¯•å›¾ç‰‡ï¼ˆåŒ…å«è¡¨å•æ•°æ®ï¼‰
- `test_audio.wav` - æµ‹è¯•éŸ³é¢‘ï¼ˆ16kHz WAVæ ¼å¼ï¼‰

---

## ğŸ” åŠŸèƒ½æµ‹è¯•

### æµ‹è¯• 1ï¼šå¥åº·æ£€æŸ¥

```bash
curl http://localhost:8000/api/health
```

**é¢„æœŸè¿”å›**ï¼š
```json
{
  "status": "healthy",
  "service": "smart-form-backend"
}
```

---

### æµ‹è¯• 2ï¼šå‘é‡æ£€ç´¢åŠŸèƒ½

åˆ›å»º `test_vector_search.py`ï¼š

```python
import asyncio
from app.services.knowledge_base import vector_store

async def test_search():
    """æµ‹è¯•å‘é‡æ£€ç´¢"""
    print("åˆå§‹åŒ–å‘é‡åº“...")
    await vector_store.initialize()
    
    # æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        ("çº¢å¯ŒåœŸè‹¹æœ", "product"),  # OCR é”™è¯¯è¯†åˆ«
        ("å¼ æ•£", "customer"),        # å§“åè¯†åˆ«é”™è¯¯
        ("å…¬æ–¤", "unit"),            # å•ä½
    ]
    
    for query, category in test_cases:
        print(f"\næŸ¥è¯¢: '{query}' (ç±»åˆ«: {category})")
        results = await vector_store.search(query, top_k=3, category=category)
        
        for i, result in enumerate(results, 1):
            print(f"  {i}. {result['text']}")
            print(f"     ç›¸ä¼¼åº¦: {result['combined_score']:.3f}")
        
        # æµ‹è¯•æ ¡å‡†
        calibrated, confidence, is_amb, candidates = await vector_store.calibrate_text(
            query, category=category
        )
        print(f"\næ ¡å‡†ç»“æœ:")
        print(f"  åŸæ–‡: {query}")
        print(f"  æ ¡å‡†: {calibrated}")
        print(f"  ç½®ä¿¡åº¦: {confidence:.2f}")
        print(f"  æ­§ä¹‰: {is_amb}")
        if candidates:
            print(f"  å€™é€‰: {candidates}")

if __name__ == "__main__":
    asyncio.run(test_search())
```

è¿è¡Œï¼š
```bash
python test_vector_search.py
```

---

### æµ‹è¯• 3ï¼šå›¾ç‰‡è¯†åˆ« API

#### æ–¹å¼ 1ï¼šä½¿ç”¨ curl

```bash
curl -X POST "http://localhost:8000/api/workflow/visual" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@tests/test_data/test_image.jpg" \
  -F "template_id=fruit_order"
```

#### æ–¹å¼ 2ï¼šä½¿ç”¨ Python

åˆ›å»º `test_image_api.py`ï¼š

```python
import requests

def test_image_recognition():
    """æµ‹è¯•å›¾ç‰‡è¯†åˆ« API"""
    url = "http://localhost:8000/api/workflow/visual"
    
    # è¯»å–æµ‹è¯•å›¾ç‰‡
    with open("tests/test_data/test_image.jpg", "rb") as f:
        files = {"file": f}
        response = requests.post(url, files=files)
    
    print("çŠ¶æ€ç :", response.status_code)
    print("å“åº”:")
    
    import json
    print(json.dumps(response.json(), indent=2, ensure_ascii=False))
    
    # æ£€æŸ¥è¿”å›ç»“æœ
    data = response.json()
    assert data["code"] == 200, "è¯†åˆ«å¤±è´¥"
    assert "rows" in data["data"], "ç¼ºå°‘è¡¨æ ¼æ•°æ®"
    
    print(f"\nâœ… æˆåŠŸæå– {len(data['data']['rows'])} è¡Œæ•°æ®")

if __name__ == "__main__":
    test_image_recognition()
```

è¿è¡Œï¼š
```bash
python test_image_api.py
```

---

### æµ‹è¯• 4ï¼šè¯­éŸ³è¯†åˆ« API

åˆ›å»º `test_audio_api.py`ï¼š

```python
import requests

def test_audio_recognition():
    """æµ‹è¯•è¯­éŸ³è¯†åˆ« API"""
    url = "http://localhost:8000/api/workflow/audio"
    
    # è¯»å–æµ‹è¯•éŸ³é¢‘
    with open("tests/test_data/test_audio.wav", "rb") as f:
        files = {"file": f}
        response = requests.post(url, files=files)
    
    print("çŠ¶æ€ç :", response.status_code)
    print("å“åº”:")
    
    import json
    print(json.dumps(response.json(), indent=2, ensure_ascii=False))
    
    # æ£€æŸ¥è¿”å›ç»“æœ
    data = response.json()
    assert data["code"] == 200, "è¯†åˆ«å¤±è´¥"
    assert "asr_text" in data["data"], "ç¼ºå°‘ ASR ç»“æœ"
    
    print(f"\nâœ… ASR è¯†åˆ«ç»“æœ: {data['data']['asr_text']}")

if __name__ == "__main__":
    test_audio_recognition()
```

---

### æµ‹è¯• 5ï¼šWebSocket å®æ—¶æ¨é€

åˆ›å»º `test_websocket.py`ï¼š

```python
import asyncio
import websockets
import json

async def test_websocket_connection():
    """æµ‹è¯• WebSocket è¿æ¥"""
    uri = "ws://localhost:8000/ws/agent"
    
    print("è¿æ¥ WebSocket...")
    async with websockets.connect(uri) as websocket:
        
        # æµ‹è¯•å¿ƒè·³
        print("\næµ‹è¯• 1: å¿ƒè·³")
        await websocket.send(json.dumps({"type": "ping"}))
        response = await websocket.recv()
        print(f"æ”¶åˆ°: {response}")
        assert json.loads(response)["type"] == "pong"
        
        # æµ‹è¯•å›¾ç‰‡å¤„ç†æµ
        print("\næµ‹è¯• 2: å›¾ç‰‡å¤„ç†æµ")
        await websocket.send(json.dumps({
            "type": "process_image",
            "data": {"image_id": "test123"}
        }))
        
        # æ¥æ”¶å¤šæ¡æ¶ˆæ¯
        for i in range(5):
            response = await websocket.recv()
            msg = json.loads(response)
            print(f"[{msg['type']}] {msg['content']}")
        
        print("\nâœ… WebSocket æµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    asyncio.run(test_websocket_connection())
```

è¿è¡Œï¼š
```bash
pip install websockets
python test_websocket.py
```

---

### æµ‹è¯• 6ï¼šæ¨¡æ¿åˆ—è¡¨ API

```bash
curl http://localhost:8000/api/template/list
```

**é¢„æœŸè¿”å›**ï¼š
```json
{
  "code": 200,
  "message": "è·å–æˆåŠŸ",
  "data": {
    "templates": [
      {
        "template_id": "fruit_order",
        "template_name": "æ°´æœè®¢å•è¡¨",
        "fields": [...]
      }
    ]
  },
  "trace_id": "..."
}
```

---

### æµ‹è¯• 7ï¼šè¡¨å•æäº¤ API

åˆ›å»º `test_submit_form.py`ï¼š

```python
import requests
import json

def test_form_submit():
    """æµ‹è¯•è¡¨å•æäº¤"""
    url = "http://localhost:8000/api/form/submit"
    
    payload = {
        "template_id": "fruit_order",
        "rows": [
            [
                {
                    "key": "product_name",
                    "label": "å•†å“åç§°",
                    "value": "çº¢å¯Œå£«è‹¹æœ",
                    "confidence": 0.95,
                    "is_ambiguous": False,
                    "data_type": "string"
                },
                {
                    "key": "quantity",
                    "label": "æ•°é‡",
                    "value": "10",
                    "confidence": 1.0,
                    "is_ambiguous": False,
                    "data_type": "number"
                }
            ]
        ],
        "user_id": "test_user"
    }
    
    response = requests.post(url, json=payload)
    print("çŠ¶æ€ç :", response.status_code)
    print("å“åº”:")
    print(json.dumps(response.json(), indent=2, ensure_ascii=False))
    
    data = response.json()
    assert data["code"] == 200, "æäº¤å¤±è´¥"
    print("\nâœ… è¡¨å•æäº¤æˆåŠŸ")

if __name__ == "__main__":
    test_form_submit()
```

---

### æµ‹è¯• 8ï¼šçŸ¥è¯†åº“åŒæ­¥ API

```bash
curl -X POST "http://localhost:8000/api/sync/knowledge" \
  -H "Content-Type: application/json" \
  -d '{"source": "mysql", "force_rebuild": true}'
```

---

## ğŸ”— å‰åç«¯è”è°ƒæµ‹è¯•

### 1. å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd ../frontend
npm run dev
```

### 2. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
python main.py
```

### 3. åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•

è®¿é—® `http://localhost:3000`

#### æµ‹è¯•æµç¨‹ï¼š
1. âœ… æ‰“å¼€é¡µé¢ï¼Œæ£€æŸ¥ä¸‰æ å¸ƒå±€
2. âœ… ä¸Šä¼ æµ‹è¯•å›¾ç‰‡
3. âœ… æŸ¥çœ‹è¡¨æ ¼æ˜¯å¦è‡ªåŠ¨å¡«å……
4. âœ… æ£€æŸ¥æ­§ä¹‰é¡¹æ˜¯å¦æ ‡é»„
5. âœ… ç‚¹å‡»å½•éŸ³æŒ‰é’®ï¼Œæµ‹è¯•è¯­éŸ³å‘½ä»¤
6. âœ… è§‚å¯Ÿä¸­æ å¯è§†åŒ–æ˜¯å¦å®æ—¶æ›´æ–°

---

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### ä½¿ç”¨ Apache Bench

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹
ab -n 1000 -c 10 http://localhost:8000/api/health

# æµ‹è¯•æ¨¡æ¿åˆ—è¡¨
ab -n 100 -c 5 http://localhost:8000/api/template/list
```

### ä½¿ç”¨ Python å¹¶å‘æµ‹è¯•

åˆ›å»º `test_performance.py`ï¼š

```python
import asyncio
import aiohttp
import time

async def test_concurrent_requests():
    """å¹¶å‘æµ‹è¯•"""
    url = "http://localhost:8000/api/health"
    num_requests = 100
    
    async def fetch(session):
        async with session.get(url) as response:
            return await response.json()
    
    start_time = time.time()
    
    async with aiohttp.ClientSession() as session:
        tasks = [fetch(session) for _ in range(num_requests)]
        results = await asyncio.gather(*tasks)
    
    duration = time.time() - start_time
    
    print(f"å®Œæˆ {num_requests} ä¸ªè¯·æ±‚")
    print(f"æ€»è€—æ—¶: {duration:.2f} ç§’")
    print(f"å¹³å‡è€—æ—¶: {duration/num_requests*1000:.2f} ms/è¯·æ±‚")
    print(f"QPS: {num_requests/duration:.2f}")

if __name__ == "__main__":
    asyncio.run(test_concurrent_requests())
```

---

## ğŸ› é”™è¯¯åœºæ™¯æµ‹è¯•

### æµ‹è¯•æ— æ•ˆè¾“å…¥

```python
import requests

def test_invalid_inputs():
    """æµ‹è¯•é”™è¯¯å¤„ç†"""
    
    # æµ‹è¯• 1: ç©ºæ–‡ä»¶
    response = requests.post(
        "http://localhost:8000/api/workflow/visual",
        files={"file": ("empty.jpg", b"", "image/jpeg")}
    )
    print("ç©ºæ–‡ä»¶:", response.json()["code"])
    
    # æµ‹è¯• 2: æ— æ•ˆæ ¼å¼
    response = requests.post(
        "http://localhost:8000/api/workflow/visual",
        files={"file": ("test.txt", b"not an image", "text/plain")}
    )
    print("æ— æ•ˆæ ¼å¼:", response.json()["code"])
    
    # æµ‹è¯• 3: ç¼ºå°‘å‚æ•°
    response = requests.post("http://localhost:8000/api/form/submit", json={})
    print("ç¼ºå°‘å‚æ•°:", response.status_code)

if __name__ == "__main__":
    test_invalid_inputs()
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] API æ–‡æ¡£å¯è®¿é—®
- [ ] å‘é‡ç´¢å¼•åŠ è½½æˆåŠŸ

### API æ¥å£
- [ ] å›¾ç‰‡è¯†åˆ«æ¥å£æ­£å¸¸
- [ ] è¯­éŸ³è¯†åˆ«æ¥å£æ­£å¸¸
- [ ] æ¨¡æ¿åˆ—è¡¨æ¥å£æ­£å¸¸
- [ ] è¡¨å•æäº¤æ¥å£æ­£å¸¸
- [ ] çŸ¥è¯†åº“åŒæ­¥æ¥å£æ­£å¸¸

### WebSocket
- [ ] è¿æ¥å»ºç«‹æˆåŠŸ
- [ ] å¿ƒè·³ä¿æ´»æ­£å¸¸
- [ ] å®æ—¶æ¶ˆæ¯æ¨é€æ­£å¸¸

### æ ¸å¿ƒåŠŸèƒ½
- [ ] OCR è¯†åˆ«å‡†ç¡®
- [ ] æ–‡æœ¬æ ¡å‡†å‡†ç¡®
- [ ] æ­§ä¹‰æ£€æµ‹æ­£ç¡®
- [ ] å‘é‡æ£€ç´¢æœ‰æ•ˆ

### å‰åç«¯è”è°ƒ
- [ ] CORS é…ç½®æ­£ç¡®
- [ ] æ•°æ®æ ¼å¼è½¬æ¢æ­£ç¡®ï¼ˆsnake_case â†” camelCaseï¼‰
- [ ] WebSocket åŒå‘é€šä¿¡æ­£å¸¸
- [ ] é”™è¯¯å¤„ç†å‹å¥½

---

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

```markdown
## æµ‹è¯•æŠ¥å‘Š - YYYY-MM-DD

### æµ‹è¯•ç¯å¢ƒ
- Python ç‰ˆæœ¬: 3.12
- æ“ä½œç³»ç»Ÿ: Windows/Linux/macOS
- é˜¿é‡Œäº‘æœåŠ¡: DashScope

### æµ‹è¯•ç»“æœ
| åŠŸèƒ½æ¨¡å— | æµ‹è¯•ç”¨ä¾‹ | ç»“æœ | å¤‡æ³¨ |
|---------|---------|------|------|
| å¥åº·æ£€æŸ¥ | /api/health | âœ… | - |
| å›¾ç‰‡è¯†åˆ« | /api/workflow/visual | âœ… | - |
| è¯­éŸ³è¯†åˆ« | /api/workflow/audio | âœ… | - |
| WebSocket | /ws/agent | âœ… | - |

### æ€§èƒ½æŒ‡æ ‡
- QPS: 50 req/s
- å¹³å‡å“åº”æ—¶é—´: 200ms
- 99åˆ†ä½å“åº”æ—¶é—´: 500ms

### é—®é¢˜æ¸…å•
1. [ ] æ— 

### ç»“è®º
æ‰€æœ‰æµ‹è¯•é€šè¿‡ âœ…
```

---

**æµ‹è¯•æ„‰å¿«ï¼** ğŸ§ª

