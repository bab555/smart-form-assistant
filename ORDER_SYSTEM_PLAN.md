# 订单系统改造计划 (Order System Refactor Plan)

## 目标
将现有的通用智能表格系统改造为专业的**订单录入与处理系统**。

---

## Phase 1: 界面与布局重构 (UI/UX) ✅ 已完成

### 1.1 整体视觉风格
- [x] **白蓝配色主题**：
  - 移除当前的深色/科技风背景。
  - 采用经典的商务白蓝配色（White/Blue/Gray）。
  - 强调清晰度与专业感，减少动效干扰。

### 1.2 布局结构调整
- [x] **左侧操作面板 (Sidebar)**：
  - **样式**：回归传统侧边栏模式，占据左侧 30%-40% 宽度，高度铺满屏幕。
  - **功能**：集成聊天对话、文件上传、图片上传、状态反馈。所有输入输出交互均在此完成。
  - **特性**：支持反向下载（生成的表格文件可在聊天记录中点击下载）。
- [x] **右侧表格工作区 (Workspace)**：
  - **样式**：占据剩余右侧空间，表格内容默认铺满容器。
  - **多表管理**：
    - 废弃无限画布拖拽模式。
    - 采用 **Excel Sheet 页签模式**（底部或顶部 Tab：Sheet1, Sheet2...）。
    - 每次只显示一张激活的表格 (Active Sheet)。

### 1.3 表格交互优化
- [x] **关闭保护**：点击关闭表格（或 Sheet）时，弹出确认框。
  - 选项：[直接关闭]、[下载并关闭]、[取消]。
- [x] **右键菜单**：保留现有右键功能，适配 Sheet 模式。

---

## Phase 2: 核心业务逻辑适配 (Business Logic) ✅ 已完成

### 2.1 订单标准表头 (Schema)
- [x] **固定表头**：系统默认且仅支持以下格式（目前阶段）：
  - `序号` | `品名` | `数量` | `单位` | `规格` | `备注` | `校验结果`
- [x] **扩展性预留**：虽然目前固定，但后端逻辑需保留支持"手动录入表头"或"上传文件表头"的接口能力。
- [x] **新建逻辑**：新建即为上述标准订单模板。

### 2.2 订单头部信息 (Header Metadata)
- [x] **元数据区域**：在表格上方（Sheet 标签下方）增加信息录入区。
- [x] **客户选择**：
  - 下拉列表（支持搜索/检索）。
  - 数据源：Mock 一个 `CustomerSkill` 数据集。
  - 作用：用于关联"用户偏好"。
- [x] **录入时间**：
  - 日期时间选择器。
  - 默认值：当前时间（精确到分钟）。
  - 支持手动修改。

### 2.3 校验与匹配逻辑 (Calibration)
- [x] **规则分级**：
  1.  **文件直入 (Excel/Word) & 印刷体识别**：
      - 执行规则匹配（拼音近似、缺字、多字）。
      - 显示：`库中商品建议: [结果A, 结果B]`。
  2.  **手写体识别**：
      - 沿用 VL 视觉识别 + Handwriting Hints。
      - 显示：提供库中可能的匹配结果。
  3.  **无匹配**：
      - 显示：`表中无该商品，请手动修改或联系管理员`。
      - 价格处理：若匹配不到或价格为0，提示`无价格`。

### 2.4 大模型操作逻辑适配 (LLM Agent Adaptation)
*由于 UI 变为 Sheet 模式，上下文更明确，LLM 操作逻辑需简化。*

- [x] **默认上下文 (Default Context)**：
  - **规则**：用户未指定表格时，所有操作（增删改查、计算）默认作用于 **当前激活的 Sheet (Active Sheet)**。
  - **实现**：System Prompt 中动态注入 `Current Active Sheet: [Sheet Name/ID]`。
- [x] **Sheet 映射逻辑**：
  - **自然语言映射**：用户指令 "第二张表"、"Sheet2"、"下一个表" -> 自动映射为对应的 `table_id`。
  - **工具参数**：`modify_cell`, `add_row` 等工具的 `table_id` 参数变为**可选**。若为空，后端自动填充为 Active Sheet ID。
- [x] **表操作扩展**：
  - 支持批量操作：LLM 可遍历所有 Sheet ID 调用工具。

---

## Phase 3: 高级功能增强 (Advanced Features) ✅ 已完成

### 3.1 行级操作与偏好记忆
- [x] **行操作**：
  - 每行末尾增加"删除"按钮（减号图标）。
- [ ] **偏好记忆 (Preference Memory)**：（后续迭代）
  - **触发场景**：用户点击删除行，或手动修改了"品名"列的内容。
  - **交互**：弹出选项 [仅本次修改] / [记录为该客户偏好]。
  - **逻辑**：
    - 记录映射关系：`{ ClientID, OriginalInput } -> PreferredProduct`。
    - **自动应用**：下次该客户录入相同 `OriginalInput`（如"土豆"）时，自动替换为 `PreferredProduct`（如"小土豆"）。

### 3.2 数据流整合
- [x] **统一入口**：所有文件（Excel/Word/图片/PDF）上传后，均在左侧显示处理进度，处理完成后在右侧生成新的 Sheet。
- [x] **导出功能**：支持将当前 Sheet 导出为 Excel，或将所有 Sheet 导出。

---

## 技术实现路径

1.  **CSS 重构**：定义 `:root` 变量，替换现有深色样式。
2.  **Layout 组件重构**：拆分 `App.tsx` 为 `Sidebar` 和 `SheetContainer`。
3.  **Store 更新**：`useCanvasStore` 增加 `activeSheetId`, `clients`, `preferences` 等状态。
4.  **Backend 更新**：
    - 更新 `push_rows_node` 逻辑，强制使用固定 Schema。
    - 增加 `PreferenceService` (Mock) 用于处理偏好逻辑。
    - 更新 `Calibration` 逻辑以支持基于 Client 的偏好注入。
    - **LLM Agent**：更新 System Prompt 和 Tool Definition，移除强制 `table_id` 限制，增加 Sheet 上下文感知。
